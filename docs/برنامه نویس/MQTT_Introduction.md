# مستند ماژول MQTT

این ماژول مسئول برقراری ارتباط پایدار با سرور **MQTT Broker** در پروژه است.  
طراحی آن به گونه‌ای انجام شده که هم اتصال دائمی حفظ شود و هم فرآیند راه‌اندازی وب‌اپلیکیشن ASP.NET Core مختل نگردد.

---

## اجزای اصلی

1. **کلاس مدیریت اتصال (Helper):**
   - مسئول ایجاد اتصال به MQTT Broker.
   - نگهداری اطلاعات وضعیت اتصال.
   - مسئول ارسال و دریافت پیام‌ها (Publish/Subscribe).
   - فاقد هرگونه حلقه دائمی یا عملیات طولانی‌مدت درون خودش.

2. **کلاس سرویس پس‌زمینه (Background Service):**
   - اجرای حلقه‌ای در پس‌زمینه جهت بررسی مستمر اتصال.
   - تلاش برای reconnect شدن در صورت قطع ارتباط.
   - جلوگیری از مسدود شدن Thread شروع برنامه با اجرای حلقه در پس‌زمینه.

---

## جریان کاری ماژول

1. پس از راه‌اندازی برنامه، سرویس پس‌زمینه (`Background Service`) فعال می‌شود.
2. این سرویس با فواصل زمانی مشخص بررسی می‌کند که آیا به MQTT متصل هستیم یا خیر.
3. در صورت عدم اتصال، درخواست ایجاد ارتباط از طریق کلاس مدیریت اتصال (Helper) ارسال می‌شود.
4. در سطح Helper، عملیات لازم برای اتصال و ثبت Subscribe‌ها انجام می‌گیرد.
5. در طول اجرای برنامه، حلقه پس‌زمینه مانع از قطع طولانی‌مدت ارتباط با Broker می‌شود.

---

## دلایل این طراحی

- **عدم بلاک شدن فرآیند Startup:**  
  حلقه اتصال در یک Thread یا Task جداگانه اجرا می‌شود تا فرآیند بالا آمدن وب‌سرور و پاسخ‌گویی HTTP بدون تأخیر انجام شود.

- **تفکیک مسئولیت‌ها:**  
  ماژول به دو بخش مستقل تقسیم شده؛ یکی صرفاً برای عملیات اتصال و دیگری برای کنترل طول عمر و تکرار تلاش‌ها.

- **خوانایی و نگهداری آسان‌تر:**  
  حذف حلقه‌های دائمی از کلاس Helper باعث تست‌پذیری بهتر و جلوگیری از رفتارهای پیش‌بینی‌نشده در startup می‌شود.

- **پایداری ارتباط:**  
  سرویس پس‌زمینه به‌طور پیوسته وضعیت اتصال را بررسی کرده و در صورت نیاز اقدام به reconnect می‌کند.

---

## مزایای نهایی این رویکرد

- تجربه کاربری روان‌تر به دلیل عدم تأخیر در راه‌اندازی.
- جلوگیری از دوبار متصل شدن هم‌زمان و تداخل حلقه‌های موازی.
- طراحی ماژولار که امکان توسعه و افزودن ویژگی‌های جدید (مانند مدیریت صف پیام‌ها یا ثبت لاگ پیشرفته) را فراهم می‌کند.
- سازگاری کامل با الگوی استاندارد **IHostedService** یا **BackgroundService** در ASP.NET Core.

---

## مسیرهای آینده توسعه

- افزودن مکانیزم صف‌بندی پیام‌ها برای مواقع قطع اتصال.
- پیاده‌سازی پیشرفته‌تر Subscriptionها با مدیریت دستی موضوعات (Topics).
- مانیتورینگ لحظه‌ای وضعیت ارتباط از طریق داشبورد مدیریتی.
- پشتیبان‌گیری و بازیابی وضعیت پس از reconnect شدن.

---

**خلاصه:**  
با انتقال منطق حلقه اتصال به سرویس پس‌زمینه و سبک‌سازی کلاس مدیریت اتصال، ماژول MQTT اکنون پایدار، انعطاف‌پذیر و سازگار با معماری استاندارد ASP.NET Core است و به‌راحتی می‌تواند در آینده گسترش یابد.
